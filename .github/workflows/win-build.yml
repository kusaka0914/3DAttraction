name: Build Windows Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install vcpkg
        shell: pwsh
        run: |
          $vcpkgUrl = "https://github.com/microsoft/vcpkg/archive/refs/heads/master.zip"
          $vcpkgPath = "$env:RUNNER_TEMP\vcpkg"
          New-Item -ItemType Directory -Force -Path $vcpkgPath | Out-Null
          Invoke-WebRequest -Uri $vcpkgUrl -OutFile "$vcpkgPath\vcpkg.zip"
          Expand-Archive -Path "$vcpkgPath\vcpkg.zip" -DestinationPath $vcpkgPath -Force
          $vcpkgRoot = Get-ChildItem -Path $vcpkgPath -Directory | Select-Object -First 1
          & "$vcpkgRoot\bootstrap-vcpkg.bat"
          echo "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$vcpkgRoot" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install dependencies
        shell: pwsh
        run: |
          vcpkg install glfw3:x64-windows glm:x64-windows nlohmann-json:x64-windows sdl2-mixer:x64-windows --triplet x64-windows

      - name: Configure (CMake - Release x64)
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

      - name: Build
        run: cmake --build build --config Release --target ALL_BUILD

      # 必要なら assets/shaders をビルド後にコピー
      - name: Gather files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\SlimesSkyTravel | Out-Null
          Copy-Item build\Release\SlimesSkyTravel.exe dist\SlimesSkyTravel\
          if (Test-Path assets) { Copy-Item assets dist\SlimesSkyTravel\assets -Recurse }
          if (Test-Path shaders) { Copy-Item shaders dist\SlimesSkyTravel\shaders -Recurse }
          
          # vcpkgから必要なDLLをコピー
          $vcpkgInstalled = "$env:VCPKG_ROOT\installed\x64-windows\bin"
          if (Test-Path $vcpkgInstalled) {
            Copy-Item "$vcpkgInstalled\*.dll" dist\SlimesSkyTravel\ -ErrorAction SilentlyContinue
          }

          # 起動BATを生成
          @'
          @echo off
          cd /d "%~dp0"
          SlimesSkyTravel.exe
          pause
          '@ | Out-File -Encoding ascii dist\SlimesSkyTravel\start_game.bat

          Compress-Archive -Path dist\SlimesSkyTravel -DestinationPath SlimesSkyTravel_win_${{ github.ref_name }}.zip -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: SlimesSkyTravel_win_${{ github.ref_name }}.zip

      # タグ push のとき Release を自動作成＆zip添付
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: SlimesSkyTravel_win_${{ github.ref_name }}.zip
          generate_release_notes: true